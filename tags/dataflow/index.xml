<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Dataflow on 7sharp9</title>
    <link>http://7sharpnine.com/tags/dataflow/</link>
    <description>Recent content in Dataflow on 7sharp9</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Dave Thomas</copyright>
    <lastBuildDate>Wed, 05 Jun 2013 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://7sharpnine.com/tags/dataflow/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Monster Zero - Revisited</title>
      <link>http://7sharpnine.com/2013/06/05/2013-06-05-monster-zero-revisited/</link>
      <pubDate>Wed, 05 Jun 2013 00:00:00 +0000</pubDate>
      
      <guid>http://7sharpnine.com/2013/06/05/2013-06-05-monster-zero-revisited/</guid>
      <description>

&lt;p&gt;
&lt;figure class=&#34;img-left&#34;&gt;
    
        &lt;img src=&#34;http://upload.wikimedia.org/wikipedia/en/c/ce/KingGhidorah.jpg&#34; /&gt;
    
    
&lt;/figure&gt;
&lt;br /&gt;
This creature is capable of tremendous destruction due to it&amp;rsquo;s size, flight &lt;em&gt;(with the creature&amp;rsquo;s wings also generating hurricane strength winds)&lt;/em&gt; and possesses several breath weapons &lt;em&gt;(e.g., heat and energy)&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;What am I talking about here?  Maybe it&amp;rsquo;s &lt;a href=&#34;http://en.wikipedia.org/wiki/King_Ghidorah&#34;&gt;Monster Zero&lt;/a&gt; or &lt;a href=&#34;http://en.wikipedia.org/wiki/King_Ghidorah&#34;&gt;King Ghidorah&lt;/a&gt; as it&amp;rsquo;s sometimes known.  No it&amp;rsquo;s &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh228603.aspx&#34;&gt;TPL Dataflow&lt;/a&gt;!  &lt;!-- more --&gt;&lt;/p&gt;

&lt;p&gt;Yeah, yeah, I have a penchant for being over dramatic and writing quirky intros.  This post is about &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh228603.aspx&#34;&gt;TPL Dataflow&lt;/a&gt; otherwise known as TDF.  I have blogged about this before in my &lt;a href=&#34;http://7sharpnine.com/2012/01/22/2012-01-22-fsharp-dataflow-agents-i/&#34;&gt;TDF agent series&lt;/a&gt; but I thought it might be worth while returning to it while on the subject of monsters.&lt;/p&gt;

&lt;p&gt;The purpose of these posts is not to put you of using these libraries but to give you feel of how they might be used from an F# viewpoint.  Its not always easy to use these libraries even from C#, so jumping to another paradigm can sometimes leave you feeling bewildered, frustrated and lost.&lt;/p&gt;

&lt;h3 id=&#34;what-is-tpl-dataflow&#34;&gt;What is TPL Dataflow&lt;/h3&gt;

&lt;p&gt;According to MSDN here&amp;rsquo;s the description of TPL dataflow:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The Task Parallel Library (TPL) provides dataflow components to help increase the robustness of concurrency-enabled applications. These dataflow components are collectively referred to as the TPL Dataflow Library. This dataflow model promotes actor-based programming by providing in-process message passing for coarse-grained dataflow and pipelining tasks.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Checkout the &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh228603.aspx&#34;&gt;MSDN&lt;/a&gt; if you want to read a more in depth outline on TDF, or you could also refer to my &lt;a href=&#34;http://7sharpnine.com/2012/01/22/2012-01-22-fsharp-dataflow-agents-i/&#34;&gt;earlier posts&lt;/a&gt; too.&lt;/p&gt;

&lt;h3 id=&#34;sample-problem&#34;&gt;Sample problem&lt;/h3&gt;

&lt;p&gt;Here&amp;rsquo;s a sample problem:  We have two documents that we want to use to collate a list of word occurrences, we then want to collect the results from both documents and print out the combined results.&lt;/p&gt;

&lt;p&gt;Although we&amp;rsquo;re using TDF to solve this problem, we could of also used F# agents, Reactive Extensions, Linq, TPL, or a mix of all of those.&lt;/p&gt;

&lt;p&gt;We will stick to using the &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/dd233175.aspx&#34;&gt;F# REPL&lt;/a&gt; for this post as it&amp;rsquo;s fairly simple example and allows for a bit of interactivity.  Lets start by adding a reference, open up a few namespace&amp;rsquo;s and read a couple of text files in.  In this instance we&amp;rsquo;re going to use &lt;a href=&#34;http://en.wikipedia.org/wiki/Jane_Eyre&#34;&gt;Jane Eyre&lt;/a&gt; by Charlotte Bronte, and &lt;a href=&#34;http://en.wikipedia.org/wiki/Algernon_Blackwood#Novels&#34;&gt;The Wendigo&lt;/a&gt; by Algernon Blackwood, for no reason other than they were free to download and use as samples.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;#r &amp;quot;System.Threading.Tasks.Dataflow&amp;quot;
open System
open System.IO
open System.Threading.Tasks.Dataflow

let janeEyre = File.ReadAllText(@&amp;quot;Jane Eyre [Charlotte Bronte].txt&amp;quot;)
let theWendigo = File.ReadAllText(@&amp;quot;The Wendigo [Algernon Blackwood].txt&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The next thing we need to think about is how to count the words.  Let&amp;rsquo;s create a recursive function that counts each occurrence of a passed in word against the full text.  The &lt;code&gt;wordCount&lt;/code&gt; function recurses until &lt;code&gt;-1&lt;/code&gt; is returned from the &lt;code&gt;IndexOf&lt;/code&gt; function.  Before you argue about memory allocation, laziness etc, we&amp;rsquo;re not interested in that at the moment, we just want to solve the problem at hand.  It would be fairly easy to split the input into a lazy sequence and iterate over it so we only keep a single line in memory.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let wordCount (text: String) word =
   let rec loop position count =
      match text.IndexOf(word, position, StringComparison.InvariantCultureIgnoreCase) with
      | -1 -&amp;gt; count
      | i -&amp;gt;  loop (i + word.Length) (count + 1)
   loop 0 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we can start to create some TDF blocks, we shall create a &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh160447.aspx&#34;&gt;BroadcastBlock&lt;/a&gt; first.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A BroadcastBlock provides a buffer for storing at most one element at time, overwriting each message with the next as it arrives.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Messages are broadcast to all linked targets, all of which may consume a clone of the message.&lt;/p&gt;

&lt;p&gt;The lambda expression passed into the &lt;code&gt;BroadcastBlock&lt;/code&gt; is it&amp;rsquo;s clone function, in this case we will just use the string that is passed in: &lt;code&gt;fun s -&amp;gt; s&lt;/code&gt;.  We will be using the &lt;code&gt;BroadcastBlock&lt;/code&gt; to send the same message to multiple destinations later on.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let broadcast = BroadcastBlock(fun s -&amp;gt; s)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we will create a couple of &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh194782.aspx&#34;&gt;TransformBlocks&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A TransformBlock provides a dataflow block that invokes a provided Func(T, TResult) delegate for every data element received.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The &lt;code&gt;TransformBlock&lt;/code&gt; will accept a data element and transform it by invoking it&amp;rsquo;s transform function.  Here we will &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/dd233229.aspx&#34;&gt;partially apply&lt;/a&gt; the &lt;code&gt;wordCount&lt;/code&gt; function by passing in the first parameter &lt;code&gt;text&lt;/code&gt;.  This means that whenever the &lt;code&gt;TransformBlock&lt;/code&gt; is passed data the &lt;code&gt;wordCount&lt;/code&gt; function will already have the &lt;code&gt;text&lt;/code&gt; parameter applied and will return the number of matches from the document.  The context of passed data here will be the word that we want to find.  We&amp;rsquo;ll create one for Jane Eyre and one for The Wendigo:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let transformJaneEyre = TransformBlock(wordCount janeEyre)
let transformTheWendigo  = TransformBlock(wordCount theWendigo)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we have created three blocks we need to think about linking them together.  You can do this with the &lt;code&gt;LinkTo&lt;/code&gt; method that every dataflow block has.  We could do that by calling the &lt;code&gt;LinkTo&lt;/code&gt; methods as usual like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;broadcast.LinkTo(transformJaneEyre) |&amp;gt; ignore
broadcast.LinkTo(transformTheWendigo) |&amp;gt; ignore
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That seems a little awkward, especially as we&amp;rsquo;re not interested in the return parameter in this example, so instead we&amp;rsquo;re going to create a little function to make this a little bit easier for ourselves:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let (--&amp;gt;) source target = DataflowBlock.LinkTo(source, target) |&amp;gt; ignore
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;LinkTo&lt;/code&gt; method returns an &lt;code&gt;IDisposable&lt;/code&gt; that can be use to sever the link between the blocks that have just been joined.  There are also overloads of &lt;code&gt;LinkTo&lt;/code&gt; that allow you to specify a predicate.  There is also an overload that takes a &lt;code&gt;DataflowLinkOptions&lt;/code&gt; type which allows you to specify whether the new link is appended (&lt;code&gt;Append&lt;/code&gt;), the maximum message that can be passed before the block is unlinked (&lt;code&gt;MaxMessages&lt;/code&gt;), and finally and whether or not the completion of the former block is propagated to the latter (&lt;code&gt;PropagateCompletion&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;We can now use the &lt;code&gt;--&amp;gt;&lt;/code&gt; symbolic operator and use &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/dd233204.aspx&#34;&gt;infix notation&lt;/a&gt; to link the blocks together.  Infix operators are expected to be placed between the two operands, which means we can define the links between the block like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;broadcast --&amp;gt; transformJaneEyre
broadcast --&amp;gt; transformTheWendigo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we create a &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh160286.aspx&#34;&gt;JoinBlock&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A JoinBlock provides a dataflow block that joins across multiple dataflow sources, which are not necessarily of the same type, waiting for one item to arrive for each type before theyâ€™re all released together as a tuple that contains one item per type.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let join = JoinBlock&amp;lt;_,_,_&amp;gt;()

broadcast           --&amp;gt; join.Target1
transformJaneEyre   --&amp;gt; join.Target2
transformTheWendigo --&amp;gt; join.Target3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We create the &lt;code&gt;JoinBlock&lt;/code&gt; then link the &lt;code&gt;broadcast&lt;/code&gt;, &lt;code&gt;transformJaneEyre&lt;/code&gt;, and &lt;code&gt;transformTheWendigo&lt;/code&gt; to it.  This means that the &lt;code&gt;JoinBlock&lt;/code&gt; will wait for data from &lt;strong&gt;all&lt;/strong&gt; three blocks before sending the data on as a tuple of the three values.&lt;/p&gt;

&lt;p&gt;Finally we create the last block which is an &lt;a href=&#34;http://msdn.microsoft.com/en-us/library/hh194684.aspx&#34;&gt;ActionBlock&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;An ActionBlock provides a dataflow block that invokes a provided Action(T) delegate for every data element received.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let writeOutput = 
    ActionBlock(fun(word:String, count1, count2) -&amp;gt; 
       Console.WriteLine(&amp;quot;Word: {0}, Jane Eyre: {1}, The Wendigo: {2}&amp;quot;, 
                         word.PadRight(10),
                         (string count1).PadLeft(3), 
                         (string count2).PadLeft(3) ) )
    
join --&amp;gt; writeOutput
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Right, that completes the hook up, now all that&amp;rsquo;s left is to test it.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-fsharp&#34;&gt;let words = [|&amp;quot;cat&amp;quot;;&amp;quot;cake&amp;quot;;&amp;quot;anything&amp;quot;;&amp;quot;laugh&amp;quot;;&amp;quot;breeze&amp;quot;;&amp;quot;hysterical&amp;quot;;&amp;quot;ball&amp;quot;;&amp;quot;them&amp;quot;;&amp;quot;home&amp;quot;;&amp;quot;bird&amp;quot;|]
for word in words do 
  broadcast.Post(word) |&amp;gt; ignore
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we execute this then we we get the following output:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Word: cat       , Jane Eyre: 212, The Wendigo:  73
Word: cake      , Jane Eyre:  15, The Wendigo:   0
Word: anything  , Jane Eyre:  60, The Wendigo:  19
Word: laugh     , Jane Eyre:  68, The Wendigo:  17
Word: breeze    , Jane Eyre:  11, The Wendigo:   0
Word: hysterical, Jane Eyre:   1, The Wendigo:   1
Word: ball      , Jane Eyre:  11, The Wendigo:   1
Word: them      , Jane Eyre: 432, The Wendigo:  72
Word: home      , Jane Eyre:  90, The Wendigo:  11
Word: bird      , Jane Eyre:  35, The Wendigo:   0
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;summary&#34;&gt;Summary&lt;/h3&gt;

&lt;p&gt;From a conceptual viewpoint of view we&amp;rsquo;re creating a BroadcastBlock which connects to two TransformBlocks.  The two TransformBlocks are then connected to the JoinBlock along with the BroadcastBlock.  Finally, the JoinBlock is connected to the ActionBlock.&lt;/p&gt;

&lt;p&gt;This creates a mini network where you can simply post a message to the input of the dataflow network and it will propagate through the network.  As with Reactive Extensions marble diagrams and pipeline diagrams are a great way to visualise the process flow.&lt;/p&gt;


&lt;figure &gt;
    
        &lt;img src=&#34;https://lh5.googleusercontent.com/-r5TZAl6VERo/UbCwd4MXGTI/AAAAAAAABpg/MmQIb_0nwb8/w769-h218-no/Screen&amp;#43;Shot&amp;#43;2013-06-06&amp;#43;at&amp;#43;16.50.31.png&#34; /&gt;
    
    
&lt;/figure&gt;


&lt;p&gt;I hope that sheds a little bit of light on how a dataflow network can be created with TDF.  Extremely complex behaviour&amp;rsquo;s can be created by connecting up the simple dataflow building blocks, especially as the different block&amp;rsquo;s can run with multiple degrees of parallelism an also run asynchronously using &lt;code&gt;Task&amp;lt;T&amp;gt;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Until next time!&lt;/p&gt;

&lt;hr style=&#34;margin: 1em 0&#34;&gt;
&lt;h1 id=&#34;essential-listening&#34;&gt;Essential listening:&lt;/h1&gt;


&lt;div class=&#34;pure-g&#34;&gt;

  
  
  
  
  &lt;div class=&#34;&#34;&gt;
    &lt;div style=&#34;width: 20%; float: left;padding: 0 .2em .2em 0&#34;&gt;
        &lt;figure style=&#34;margin: 0&#34;&gt;
            &lt;img src=&#34;http://upload.wikimedia.org/wikipedia/en/4/43/AIC_Unplugged.jpg&#34; style=&#34;margin: 0&#34;
                 alt=&#34;Alice In Chains - Unplugged&#34; /&gt;
            &lt;figcaption&gt;
                &lt;h6&gt;Alice In Chains - Unplugged&lt;/h4&gt;
            &lt;/figcaption&gt;
        &lt;/figure&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  

  
  
  
  
  &lt;div class=&#34;&#34;&gt;
    &lt;div style=&#34;width: 20%; float: left;padding: 0 .2em .2em 0&#34;&gt;
        &lt;figure style=&#34;margin: 0&#34;&gt;
            &lt;img src=&#34;http://upload.wikimedia.org/wikipedia/en/6/64/MeteoraLP.jpg&#34; style=&#34;margin: 0&#34;
                 alt=&#34;Linkin Park - Meteora&#34; /&gt;
            &lt;figcaption&gt;
                &lt;h6&gt;Linkin Park - Meteora&lt;/h4&gt;
            &lt;/figcaption&gt;
        &lt;/figure&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  

  
  
  
  
  &lt;div class=&#34;&#34;&gt;
    &lt;div style=&#34;width: 20%; float: left;padding: 0 .2em .2em 0&#34;&gt;
        &lt;figure style=&#34;margin: 0&#34;&gt;
            &lt;img src=&#34;http://upload.wikimedia.org/wikipedia/en/4/44/Soilscars.jpg&#34; style=&#34;margin: 0&#34;
                 alt=&#34;Soil - Scars&#34; /&gt;
            &lt;figcaption&gt;
                &lt;h6&gt;Soil - Scars&lt;/h4&gt;
            &lt;/figcaption&gt;
        &lt;/figure&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  

&lt;/div&gt;




</description>
    </item>
    
  </channel>
</rss>